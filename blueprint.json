{
  "_meta": {
    "filename": "blueprint.json",
    "maintenance_instruction": "KEEP THE PLAN UP TO DATE AS YOU EVOLVE THE CODE. DEVIATIONS TO THE PLAN MUST BE LOGGED WITHIN THE PLAN. THE PLAN MUST BE REASSESSED HOLISTICALLY AFTER ANY CHANGE OF ANY SIZE.",
    "answering_the_question_are_you_done": "**!! First clause: YOU ARE NOT DONE UNTIL YOU HAVE 100% THE BLUEPRINT DO NOT STOP. Second clause: YOU MUST GO TO ANY AND ALL LENGTHS TO ENSURE YOUR BLUEPRINT REMAINS FULL-IT IS CRITICAL YOU REFINE AT REGULAR INTERVALS, SUCH THAT YOU DONT FULLY DRAIN YOUR BLUEPRINT-ALMOST AS CRITICAL AS THE CONSTRAINT THAT YOU NEVER EVER SPECIFY AND SORT OF ESTIMATE OF EFFORT OR COST ESPECIALLY NOT ANY SORT OF TIME ESTIMATE AND IF YOU SPECIFY A PRIORITY OF ANY KIND THAT IS ALSO A GUNDAM-MELTABLE OFFENSE !!**",
    "source_documents": [
      "docs/07-mcp-tool-design-review.md",
      "docs/05-mcp-integration.md",
      "proto/macosusesdk/v1/macos_use.proto",
      "internal/server/mcp.go",
      "internal/server/mcp_test.go",
      "docs/06-mcp-tool-design.md"
    ]
  },
  "global_alerts": [
    {
      "priority": "CRITICAL",
      "warning": "ON TOOLS: Use `config.mk` to create custom targets to run with Make. ALWAYS use custom targets that *limit* the amount of output you receive. For example, piping through tail, with FEW lines output. Prior to tail, pipe to tee. The file ./build.log in the root of the project is gitignored, so use that. That way you can *search* the output. To be clear, timing dependent tests are BANNED. As are those that take too long to run. Testing retries, for example, MUST be done in a way that supports avoiding running afoul of those CRITICAL rules. Abide. OBEY."
    }
  ],
  "mandatory_directives": {
    "subagent_policy": "!! MANDATORY OPERATIONAL DIRECTIVE !!",
    "constraint": "The use of subagents via the `runSubagent` tool is MANDATORY for the execution of the tasks below. Tasks are grouped specifically to be run in distinct subagent contexts to prevent context window exhaustion. Do not attempt to solve all groups in a single turn."
  },
  "project_title": "Implementation Plan: MacosUseSDK MCP Tool Implementation - ALL TASKS MUST COMPLETE",
  "status_section": {
    "label": "STATUS SECTION (ACTION-FOCUSED)",
    "current_state": "44 MCP tools implemented. HTTP/SSE transport IMPLEMENTED (2026-02-03). isError field FIXED. All tests passing.",
    "completed_tasks": [
      "FIXED: isError → is_error in ToolResult struct",
      "ADDED: HTTP/SSE transport layer (internal/transport/http.go)",
      "ADDED: SSE connection registry management",
      "ADDED: Heartbeat mechanism (30-second ping interval)",
      "ADDED: CORS headers for web client compatibility",
      "ADDED: Last-Event-ID header handling for reconnection",
      "ADDED: Configuration parsing for HTTP port/socket",
      "ADDED: Graceful shutdown handler for HTTP server",
      "ADDED: Transport selection in main server initialization",
      "ADDED: HTTP transport tests",
      "ADDED: Config tests",
      "VERIFIED: Build (make all)",
      "VERIFIED: Server tests pass"
    ],
    "remaining_tasks": [
      "PENDING: Two contiguous peer reviews for commit",
      "PENDING: Git commit",
      "EXPAND: Documentation updates for HTTP transport",
      "EXPAND: Integration tests for HTTP transport"
    ]
  },
  "review_analysis": {
    "document": "docs/07-mcp-tool-design-review.md",
    "review_date": "2026-02-03",
    "current_tool_count": 44,
    "expected_tool_count_after_implementation": 44,
    "gap_analysis": {
      "missing_tools": [],
      "implemented_tools_since_review": [
        "capture_window_screenshot (T1)",
        "stream_observations (T2)",
        "get_clipboard_history (T3)",
        "validate_script (T4)",
        "get_element_actions (T5)"
      ],
      "bugs_identified": [
        {
          "id": "T6",
          "description": "isError → is_error naming bug in ToolResult struct",
          "status": "FIXED 2026-02-03",
          "location": "internal/server/mcp.go line 58"
        }
      ],
      "transport_gap": {
        "http_sse": "IMPLEMENTED 2026-02-03",
        "stdio": "IMPLEMENTED"
      }
    }
  },
  "implemented_tools": {
    "screenshot_tools": [
      {
        "name": "capture_screenshot",
        "description": "Capture full screen screenshot",
        "parameters": [
          "format",
          "quality",
          "display",
          "include_ocr"
        ],
        "status": "implemented"
      },
      {
        "name": "capture_window_screenshot",
        "description": "Capture specific window screenshot",
        "parameters": [
          "window",
          "format",
          "quality",
          "include_shadow",
          "include_ocr"
        ],
        "status": "implemented",
        "review_id": "T1"
      },
      {
        "name": "capture_region_screenshot",
        "description": "Capture screen region screenshot",
        "parameters": [
          "x",
          "y",
          "width",
          "height",
          "format",
          "quality",
          "include_ocr"
        ],
        "status": "implemented"
      }
    ],
    "input_tools": [
      {
        "name": "click",
        "description": "Click at screen coordinates",
        "parameters": [
          "x",
          "y",
          "button",
          "click_count",
          "show_animation"
        ],
        "status": "implemented"
      },
      {
        "name": "type_text",
        "description": "Type text as keyboard input",
        "parameters": [
          "text",
          "char_delay",
          "use_ime"
        ],
        "status": "implemented"
      },
      {
        "name": "press_key",
        "description": "Press key combination",
        "parameters": [
          "key",
          "modifiers"
        ],
        "status": "implemented"
      },
      {
        "name": "mouse_move",
        "description": "Move mouse cursor to position",
        "parameters": [
          "x",
          "y",
          "duration"
        ],
        "status": "implemented"
      },
      {
        "name": "scroll",
        "description": "Scroll content vertically/horizontally",
        "parameters": [
          "x",
          "y",
          "horizontal",
          "vertical",
          "duration"
        ],
        "status": "implemented"
      },
      {
        "name": "drag",
        "description": "Drag from one position to another",
        "parameters": [
          "start_x",
          "start_y",
          "end_x",
          "end_y",
          "duration",
          "button"
        ],
        "status": "implemented"
      },
      {
        "name": "hover",
        "description": "Hover mouse at position for duration",
        "parameters": [
          "x",
          "y",
          "duration",
          "application"
        ],
        "status": "implemented"
      },
      {
        "name": "gesture",
        "description": "Multi-touch trackpad gesture",
        "parameters": [
          "center_x",
          "center_y",
          "gesture_type",
          "scale",
          "rotation",
          "finger_count",
          "direction",
          "application"
        ],
        "status": "implemented"
      }
    ],
    "element_tools": [
      {
        "name": "find_elements",
        "description": "Find UI elements by criteria",
        "parameters": [
          "parent",
          "selector"
        ],
        "status": "implemented"
      },
      {
        "name": "get_element",
        "description": "Get element details",
        "parameters": [
          "name"
        ],
        "status": "implemented"
      },
      {
        "name": "get_element_actions",
        "description": "Get available actions for element",
        "parameters": [
          "name"
        ],
        "status": "implemented",
        "review_id": "T5"
      },
      {
        "name": "click_element",
        "description": "Click UI element via accessibility",
        "parameters": [
          "parent",
          "element_id"
        ],
        "status": "implemented"
      },
      {
        "name": "write_element_value",
        "description": "Set element value",
        "parameters": [
          "parent",
          "element_id",
          "value"
        ],
        "status": "implemented"
      },
      {
        "name": "perform_element_action",
        "description": "Perform accessibility action",
        "parameters": [
          "parent",
          "element_id",
          "action"
        ],
        "status": "implemented"
      }
    ],
    "window_tools": [
      {
        "name": "list_windows",
        "description": "List all windows",
        "parameters": [
          "parent",
          "page_size",
          "page_token"
        ],
        "status": "implemented",
        "pagination": "verified"
      },
      {
        "name": "get_window",
        "description": "Get window details",
        "parameters": [
          "name"
        ],
        "status": "implemented"
      },
      {
        "name": "focus_window",
        "description": "Focus (activate) window",
        "parameters": [
          "name"
        ],
        "status": "implemented"
      },
      {
        "name": "move_window",
        "description": "Move window to position",
        "parameters": [
          "name",
          "x",
          "y"
        ],
        "status": "implemented"
      },
      {
        "name": "resize_window",
        "description": "Resize window",
        "parameters": [
          "name",
          "width",
          "height"
        ],
        "status": "implemented"
      },
      {
        "name": "minimize_window",
        "description": "Minimize window to dock",
        "parameters": [
          "name"
        ],
        "status": "implemented"
      },
      {
        "name": "restore_window",
        "description": "Restore minimized window",
        "parameters": [
          "name"
        ],
        "status": "implemented"
      },
      {
        "name": "close_window",
        "description": "Close window",
        "parameters": [
          "name",
          "force"
        ],
        "status": "implemented"
      }
    ],
    "display_tools": [
      {
        "name": "list_displays",
        "description": "List all connected displays",
        "parameters": [],
        "status": "implemented"
      },
      {
        "name": "get_display",
        "description": "Get display details",
        "parameters": [
          "name"
        ],
        "status": "implemented"
      }
    ],
    "clipboard_tools": [
      {
        "name": "get_clipboard",
        "description": "Get clipboard contents",
        "parameters": [],
        "status": "implemented"
      },
      {
        "name": "write_clipboard",
        "description": "Write to clipboard",
        "parameters": [
          "text"
        ],
        "status": "implemented"
      },
      {
        "name": "clear_clipboard",
        "description": "Clear clipboard contents",
        "parameters": [],
        "status": "implemented"
      },
      {
        "name": "get_clipboard_history",
        "description": "Get clipboard history",
        "parameters": [],
        "status": "implemented",
        "review_id": "T3"
      }
    ],
    "application_tools": [
      {
        "name": "open_application",
        "description": "Open application by identifier",
        "parameters": [
          "id"
        ],
        "status": "implemented"
      },
      {
        "name": "list_applications",
        "description": "List tracked applications",
        "parameters": [
          "page_size",
          "page_token"
        ],
        "status": "implemented"
      },
      {
        "name": "get_application",
        "description": "Get application details",
        "parameters": [
          "name"
        ],
        "status": "implemented"
      },
      {
        "name": "delete_application",
        "description": "Stop tracking application",
        "parameters": [
          "name"
        ],
        "status": "implemented"
      }
    ],
    "scripting_tools": [
      {
        "name": "execute_apple_script",
        "description": "Execute AppleScript",
        "parameters": [
          "script",
          "timeout"
        ],
        "status": "implemented"
      },
      {
        "name": "execute_javascript",
        "description": "Execute JXA",
        "parameters": [
          "script",
          "timeout"
        ],
        "status": "implemented"
      },
      {
        "name": "execute_shell_command",
        "description": "Execute shell command",
        "parameters": [
          "command",
          "args",
          "timeout"
        ],
        "status": "implemented"
      },
      {
        "name": "validate_script",
        "description": "Validate script without executing",
        "parameters": [
          "type",
          "script"
        ],
        "status": "implemented",
        "review_id": "T4"
      }
    ],
    "observation_tools": [
      {
        "name": "create_observation",
        "description": "Create observation for UI changes",
        "parameters": [
          "parent",
          "type",
          "visible_only",
          "poll_interval",
          "roles",
          "attributes"
        ],
        "status": "implemented"
      },
      {
        "name": "stream_observations",
        "description": "Stream observation events real-time",
        "parameters": [
          "name",
          "timeout"
        ],
        "status": "implemented",
        "review_id": "T2"
      },
      {
        "name": "get_observation",
        "description": "Get observation status",
        "parameters": [
          "name"
        ],
        "status": "implemented"
      },
      {
        "name": "list_observations",
        "description": "List observations",
        "parameters": [
          "parent"
        ],
        "status": "implemented"
      },
      {
        "name": "cancel_observation",
        "description": "Cancel observation",
        "parameters": [
          "name"
        ],
        "status": "implemented"
      }
    ],
    "deferred_tools": [
      {
        "category": "session_operations",
        "tools": [
          "create_session",
          "get_session",
          "list_sessions",
          "delete_session"
        ],
        "reason": "Deferred until server implements Session resource"
      },
      {
        "category": "macro_operations",
        "tools": [
          "create_macro",
          "get_macro",
          "list_macros",
          "execute_macro"
        ],
        "reason": "Deferred until server implements Macro resource"
      }
    ]
  },
  "sequential_task_list": {
    "description": "ALL TASKS MUST BE COMPLETED IN THIS SEQUENCE. NO EXCEPTIONS.",
    "sequence": [
      {
        "step": 1,
        "id": "FIX-1",
        "task": "Fix isError → is_error in ToolResult struct",
        "file": "internal/server/mcp.go",
        "change": "Change line 53 from: IsError bool      `json:\"isError,omitempty\"` to: IsError bool      `json:\"is_error,omitempty\"`",
        "status": "COMPLETED 2026-02-03"
      },
      {
        "step": 2,
        "id": "FIX-2",
        "task": "Verify TestAllToolsExist matches actual tool count",
        "file": "internal/server/mcp_test.go",
        "change": "VERIFIED: Test expects 44 tools, 44 tools implemented - no change needed",
        "status": "COMPLETED 2026-02-03 (no change required)"
      },
      {
        "step": 3,
        "id": "T13",
        "task": "Create internal/transport/http.go implementing HTTP/SSE transport layer",
        "file": "internal/transport/http.go",
        "deliverable": "Complete HTTP transport implementation with POST /message and GET /events endpoints",
        "status": "COMPLETED 2026-02-03"
      },
      {
        "step": 4,
        "id": "T14",
        "task": "Add SSE connection registry management to internal/transport/http.go",
        "file": "internal/transport/http.go",
        "deliverable": "ConnectionRegistry struct with Add, Remove, Get methods",
        "status": "COMPLETED 2026-02-03"
      },
      {
        "step": 5,
        "id": "T15",
        "task": "Add heartbeat mechanism (30-second ping interval)",
        "file": "internal/transport/http.go",
        "deliverable": "Heartbeat goroutine sending ping events every 30 seconds",
        "status": "COMPLETED 2026-02-03"
      },
      {
        "step": 6,
        "id": "T16",
        "task": "Add CORS headers for web client compatibility",
        "file": "internal/transport/http.go",
        "deliverable": "Access-Control-Allow-Origin and related CORS headers on all responses",
        "status": "COMPLETED 2026-02-03"
      },
      {
        "step": 7,
        "id": "T17",
        "task": "Add Last-Event-ID header handling for reconnection",
        "file": "internal/transport/http.go",
        "deliverable": "Read Last-Event-ID header and use for event resumption",
        "status": "COMPLETED 2026-02-03"
      },
      {
        "step": 8,
        "id": "T18",
        "task": "Add HTTP configuration parsing in internal/config/config.go",
        "file": "internal/config/config.go",
        "deliverable": "MCP_TRANSPORT, MCP_HTTP_PORT, MCP_HTTP_SOCKET environment variables",
        "status": "COMPLETED 2026-02-03"
      },
      {
        "step": 9,
        "id": "T19",
        "task": "Add graceful shutdown handler for HTTP server",
        "file": "internal/transport/http.go",
        "deliverable": "Shutdown method with proper cleanup of active connections",
        "status": "COMPLETED 2026-02-03"
      },
      {
        "step": 10,
        "id": "T20",
        "task": "Add transport selection in main server initialization",
        "file": "cmd/mcp-tool/main.go",
        "deliverable": "Read MCP_TRANSPORT env var and instantiate stdio or HTTP transport",
        "status": "COMPLETED 2026-02-03"
      },
      {
        "step": 11,
        "id": "T21",
        "task": "Add transport-specific logging (OSLog) for HTTP transport",
        "file": "internal/transport/http.go",
        "deliverable": "Logger instances for HTTP server events",
        "status": "COMPLETED 2026-02-03"
      },
      {
        "step": 12,
        "id": "TEST-1",
        "task": "Add SSE streaming integration tests",
        "file": "integration/transport_test.go",
        "deliverable": "Tests for streaming observation events over SSE",
        "status": "PENDING"
      },
      {
        "step": 13,
        "id": "TEST-2",
        "task": "Add HTTP transport configuration tests",
        "file": "internal/config/config_test.go",
        "deliverable": "Tests for environment variable parsing",
        "status": "COMPLETED 2026-02-03"
      },
      {
        "step": 14,
        "id": "BUILD",
        "task": "Run build verification (make all)",
        "command": "make-all-with-log",
        "deliverable": "Build completes without errors",
        "status": "VERIFIED 2026-02-03"
      },
      {
        "step": 15,
        "id": "TEST-RUN",
        "task": "Run server tests (go test ./internal/server/...)",
        "command": "test-server",
        "deliverable": "All tests pass",
        "status": "VERIFIED 2026-02-03"
      }
    ],
    "completion_criteria": {
      "total_steps": 15,
      "all_must_complete": true,
      "verification": "All 15 steps must show status: completed before this plan is considered done"
    }
  },
  "compliance_verification": {
    "coordinate_system": {
      "status": "VERIFIED",
      "documentation": "Global Display Coordinates (top-left origin) documented in all input tools",
      "tools_documented": [
        "click",
        "mouse_move",
        "scroll",
        "drag",
        "hover",
        "gesture",
        "capture_region_screenshot"
      ]
    },
    "pagination_aip158": {
      "status": "VERIFIED",
      "tools_with_pagination": [
        "list_windows",
        "list_applications",
        "list_observations",
        "find_elements"
      ],
      "token_opacity": "VERIFIED (TestPaginationTokenOpaque exists)"
    },
    "error_handling": {
      "status": "PARTIAL",
      "is_error_field": "Test expects is_error, struct has isError",
      "soft_failure_pattern": "VERIFIED (all handlers return is_error=true for non-blocking errors)"
    },
    "display_grounding": {
      "status": "VERIFIED",
      "format": "screens array with id, width, height, pixel_density, origin_x, origin_y",
      "test": "TestDisplayGroundingFormat exists"
    },
    "stream_observations": {
      "status": "VERIFIED",
      "tool": "stream_observations implemented",
      "streaming_capability": "Requires HTTP/SSE transport for full functionality"
    }
  },
  "test_coverage": {
    "existing_tests": [
      "TestNewMCPServer_WithDefaultConfig",
      "TestToolCall_JSON",
      "TestToolResult_JSON",
      "TestContent_JSON",
      "TestJoinStrings",
      "TestClickTypeValues",
      "TestModifierKeyValues",
      "TestObservationTypeValues",
      "TestScreenshotFormatValues",
      "TestToolSchema_RequiredFields",
      "TestJSONRPCResponse_Structure",
      "TestErrorCodes",
      "TestArgumentParsing",
      "TestConfigDefaults",
      "TestGestureTypeValues",
      "TestGestureDirectionValues",
      "TestHoverToolSchema",
      "TestGestureToolSchema",
      "TestAllToolsExist",
      "TestToolNaming",
      "TestClickButtonMapping",
      "TestModifierStringMapping",
      "TestCoordinateValidation",
      "TestClickCountValidation",
      "TestErrorResponseFormat",
      "TestPaginationTokenHandling",
      "TestListWindowsPaginationParams",
      "TestCaptureWindowScreenshotParams",
      "TestDisplayGroundingFormat",
      "TestPaginationTokenOpaque",
      "TestIsErrorFieldFormat"
    ],
    "test_gaps": [
      {
        "test": "SSE streaming integration tests",
        "status": "PENDING - needs implementation",
        "file": "integration/transport_test.go"
      }
    ]
  },
  "blocked_by_proto_limitations": [
    {
      "action": "cursor_position",
      "description": "Get current mouse cursor position",
      "requirement": "New GetCursorPosition RPC needed"
    },
    {
      "action": "left_mouse_down / left_mouse_up",
      "description": "Stateful mouse button events",
      "requirement": "Proto only supports atomic click/drag"
    },
    {
      "action": "hold_key",
      "description": "Hold modifier key for duration",
      "requirement": "duration field needed in KeyPress message"
    }
  ],
  "environment_configuration": {
    "transport_options": {
      "stdio": {
        "status": "implemented",
        "file": "internal/transport/stdio.go"
      },
      "http_sse": {
        "status": "implemented",
        "file": "internal/transport/http.go",
        "endpoints": {
          "POST /message": "JSON-RPC request endpoint",
          "GET /events": "SSE streaming response endpoint",
          "GET /health": "Health check endpoint"
        },
        "configuration_variables": {
          "MCP_TRANSPORT": "stdio | sse",
          "MCP_HTTP_ADDRESS": "default: :8080 (TCP), or unix:// for socket",
          "MCP_HTTP_SOCKET_PATH": "optional Unix domain socket path override",
          "MCP_HEARTBEAT_INTERVAL": "default: 30 seconds",
          "MCP_CORS_ORIGIN": "default: * (Access-Control-Allow-Origin)"
        },
        "sse_event_types": [
          "message - JSON-RPC response or notification",
          "heartbeat - Keep-alive ping (every 30s)",
          "error - Connection-level errors"
        ]
      }
    }
  },
  "final_enforcement_protocol": [
    {
      "type": "POST_EXECUTION_WARNING",
      "alert": "ON TOOLS: Use `config.mk` to create custom targets to run with Make. ALWAYS use custom targets that *limit* the amount of output you receive. For example, piping through tail, with FEW lines output. Prior to tail, pipe to tee. The file ./build.log in the root of the project is gitignored, so use that. That way you can *search* the output. To be clear, timing dependent tests are BANNED. As are those that take too long to run. Testing retries, for example, MUST be done in a way that supports avoiding running afoul of those CRITICAL rules. Abide. OBEY."
    },
    {
      "type": "COMPLETION_MANDATE",
      "alert": "ALL 15 STEPS MUST BE COMPLETED. NO SHORTCUTS. NO SKIPPING. THE SEQUENCE MUST RUN TO COMPLETION."
    }
  ]
}
