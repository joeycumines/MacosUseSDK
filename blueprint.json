{
  "_meta": {
    "filename": "blueprint.json",
    "maintenance_instruction": "KEEP THE PLAN UP TO DATE AS YOU EVOLVE THE CODE. DEVIATIONS TO THE PLAN MUST BE LOGGED WITHIN THE PLAN. THE PLAN MUST BE REASSESSED HOLISTICALLY AFTER ANY CHANGE OF ANY SIZE."
  },
  "global_alerts": [
    {
      "priority": "CRITICAL",
      "warning": "ON TOOLS: Use `config.mk` to create custom targets to run with Make. ALWAYS use custom targets that *limit* the amount of output you receive. For example, piping through tail, with FEW lines output. Prior to tail, pipe to tee. The file ./build.log in the root of the project is gitignored, so use that. That way you can *search* the output. To be clear, timing dependent tests are BANNED. As are those that take too long to run. Testing retries, for example, MUST be done in a way that supports avoiding running afoul of those CRITICAL rules. Abide. OBEY."
    },
    {
      "priority": "CRITICAL_REPEATED",
      "warning": "ON TOOLS: Use `config.mk` to create custom targets to run with Make. ALWAYS use custom targets that *limit* the amount of output you receive. For example, piping through tail, with FEW lines output. Prior to tail, pipe to tee. The file ./build.log in the root of the project is gitignored, so use that. That way you can *search* the output. To be clear, timing dependent tests are BANNED. As are those that take too long to run. Testing retries, for example, MUST be done in a way that supports avoiding running afoul of those CRITICAL rules. Abide. OBEY."
    }
  ],
  "mandatory_directives": {
    "subagent_policy": "!! MANDATORY OPERATIONAL DIRECTIVE !!",
    "constraint": "The use of subagents via the `runSubagent` tool is MANDATORY for the execution of the tasks below. Tasks are grouped specifically to be run in distinct subagent contexts to prevent context window exhaustion. Do not attempt to solve all groups in a single turn."
  },
  "project_title": "Implementation Plan: MacosUseSDK gRPC Service",
  "status_section": {
    "label": "STATUS SECTION (ACTION-FOCUSED)",
    "current_state": "STATE MANAGEMENT AND CONCURRENCY ANALYSIS COMPLETE. Created STATE_MANAGEMENT_CONCURRENCY_REPORT.md with comprehensive assessment. Key findings: (1) Actor-based architecture is sound; (2) Three concerns identified: unsafe singleton initialization (requires documentation), observation cancellation race condition (low impact, should fix), task cleanup gaps (low priority); (3) No memory leaks detected; (4) Memory safety excellent; (5) Performance acceptable with MainActor serialization by design; (6) Production readiness approved with HIGH PRIORITY remediations. Previous task status: ALL DESIGNATED TASKS COMPLETE + BONUS. 481 Swift tests (388 MacosUseServer + 70 MacosUseSDK + 23 Swift Testing), 0 failures. All Go integration tests pass. Session commits: 5f27851, f278bf8, 02880a7, 72abf7f, 0e5ac48, 582dfc5, f5004c7, b9ddf02, b2e073b, 99d93f5, ea1b1ec, b351c1c, 157779c (26 OverlayDescriptor tests).",
    "update_instruction": "To provide an update, return to this 'status_section' object and modify the 'current_state'."
  },
  "implementation_phases": [
    {
      "name": "Accessibility Traversal Remediation Blueprint",
      "description": "Exhaustive plan to resolve accessibility traversal defects and implement hierarchical pathing for node-like representation.",
      "tasks": [
        {
          "id": "SDK-001",
          "category": "SDK",
          "title": "Refactor ElementData Identity",
          "description": "Update ElementData struct to include hierarchical path and refine Hashable conformance to prevent aggressive deduplication.",
          "steps": [
            "In Sources/MacosUseSDK/AccessibilityTraversal.swift, add `public var path: [Int32]` to `ElementData`.",
            "Update `ElementData.hash(into:)` to include `path` in the hasher.",
            "Update `ElementData.==` to include `path` in the equality check.",
            "Update `ElementData.CodingKeys` to include `path` (or ensure it's handled if using default Codable)."
          ]
        },
        {
          "id": "SDK-002",
          "category": "SDK",
          "title": "Implement Hierarchical Path Recursion",
          "description": "Modify the traversal recursion to generate and pass down the logical hierarchical path of each element.",
          "steps": [
            "Update `walkElementTree` signature in `AccessibilityTraversal.swift` to accept `currentPath: [Int32]`.",
            "In the root call to `walkElementTree`, pass `[]` as the initial path.",
            "When recursing into children, append the 0-based index of the child to the parent's path.",
            "When recursing into windows or main windows, define a deterministic indexing strategy if they aren't part of the regular children array.",
            "Update the `ElementData` instantiation inside `walkElementTree` to use the generated `currentPath`."
          ]
        },
        {
          "id": "SRV-001",
          "category": "Server",
          "title": "Fix Concurrency - Remove Main Thread Blocking",
          "description": "Ensure traversal runs off the main thread where possible to prevent blocking the server's event loop.",
          "steps": [
            "In Server/Sources/MacosUseServer/ElementLocator.swift, remove the `MainActor.run` wrapper around `MacosUseSDK.traverseAccessibilityTree`.",
            "Analyze `AccessibilityTraversal.swift` for any internal calls that *must* be on the main thread (e.g., app activation) and wrap only those specific calls in `MainActor.run`.",
            "Verify that `AXUIElement` operations are safe to run on background threads (as per code comments and CF thread-safety rules)."
          ]
        },
        {
          "id": "SRV-002",
          "category": "Server",
          "title": "Restore Path Integrity in ElementLocator",
          "description": "Stop using fake sequential indices and map the SDK's hierarchical path directly to the proto elements.",
          "steps": [
            "In `traverseWithPaths` in `ElementLocator.swift`, stop using the loop `index` to fabricate paths.",
            "Map `elementData.path` directly to `protoElement.path`."
          ]
        },
        {
          "id": "SRV-003",
          "category": "Server",
          "title": "Resolve Double Registration Resource Leak",
          "description": "Ensure elements are registered in ElementRegistry exactly once per traversal, preserving the AXUIElement reference.",
          "steps": [
            "Refactor `ElementLocator.swift` and `ElementMethods.swift` to avoid redundant calls to `ElementRegistry.shared.registerElement`.",
            "Ensure the registration happens during the proto conversion loop where the `AXUIElement` reference is still available.",
            "Update `ElementMethods.swift` to use the element IDs already generated and returned by `ElementLocator` instead of re-registering them."
          ]
        },
        {
          "id": "SRV-004",
          "category": "Server",
          "title": "Fix Selector Matching Logic",
          "description": "Address defects in selector matching, including the NOT operator and regex error handling.",
          "steps": [
            "Update `matchesSelector` in `ElementLocator.swift` for the `NOT` operator: implement logic that correctly evaluates sub-selectors (e.g., using `!subMatches.allSatisfy { $0 }`).",
            "Modify regex matching in `matchesSelector` to throw an `RPCError(.invalidArgument)` when `NSRegularExpression` fails, instead of swallowing it.",
            "Ensure all compound operators (AND, OR, NOT) handle multiple sub-selectors logically as per expectations."
          ]
        },
        {
          "id": "SRV-005",
          "category": "Server",
          "title": "Standardize Geometric Calculations",
          "description": "Move to a pure Euclidean distance model measured from element centers.",
          "steps": [
            "In `ElementLocator.swift`, update the `.position` criteria matching: calculate distance from the element's center `(x + width/2, y + height/2)` instead of the top-left corner.",
            "In Server/Sources/MacosUseServer/ElementHelpers.swift, update `findMatchingElement` to use Euclidean distance instead of Manhattan distance.",
            "Standardize the tolerance check across the codebase to use `hypot` (Euclidean distance)."
          ]
        },
        {
          "id": "SRV-006",
          "category": "Server",
          "title": "Harden ElementRegistry",
          "description": "Ensure atomic operations in the registry to prevent race conditions during element lookup and expiration.",
          "status": "complete",
          "notes": "ElementRegistry is an actor, ensuring serialized access. Fixed fragile force-unwrap pattern in updateElement by using safe optional binding with existing element.",
          "steps": [
            "Review `ElementRegistry.swift` for any split check-then-modify patterns that could lead to crashes or inconsistencies.",
            "Ensure that if an element is found to be expired during `getElement`, its removal is handled safely without affecting the current request if possible, or returned as `nil` consistently."
          ]
        },
        {
          "id": "SRV-007",
          "category": "Server",
          "title": "Implement ListDisplays RPC",
          "description": "Add ListDisplays RPC implementation and integration tests that enumerate system displays and return Display messages with frame, visible_frame, is_main, and scale.",
          "status": "complete",
          "notes": "Implementation verified by 2 contiguous clean peer reviews. Coordinate conversion correct. Test validates frame dimensions, position constraints, and scale.",
          "steps": [
            "Add Server/Sources/MacosUseServer/DisplayMethods.swift with `func listDisplays` implementation using CGGetActiveDisplayList, CGDisplayBounds, and (on MainActor) NSScreen.visibleFrame and backingScaleFactor.",
            "Implement pagination using encodePageToken/decodePageToken per AIP-158.",
            "Add integration test `integration/display_test.go` verifying at least one display and the correctness of returned fields. (FIX: repair corrupted file content if necessary.)",
            "Run `mcp-server-make swift.all` then `mcp-server-make make-all-with-log` to verify Swift and Go tests and lints pass.",
            "Update docs/ and AGENTS.md if necessary to document coordinate system and Display semantics."
          ]
        }
      ]
    },

    {
      "phase_id": "Phase 4",
      "title": "Testing Strategy",
      "subsections": [
        {
          "id": "4.1",
          "title": "Unit Tests",
          "requirements": [
            {
              "type": "Requirement",
              "content": "Every fix must have accompanying unit test verification."
            },
            {
              "type": "Strictness",
              "content": "`integration/observation_test.go` must remain an EFFECTIVE test of the logic it covers."
            }
          ]
        },
        {
          "id": "4.2",
          "title": "Test Harness",
          "details": {
            "golden_apps": [
              "TextEdit",
              "Calculator",
              "Finder"
            ],
            "lifecycle_constraint": "Tests must clean up resources (DeleteApplication) aggressively."
          }
        },
        {
          "title": "Correctness & Verification Guarantees",
          "guarantees": [
            {
              "rule": "State-Difference Assertions",
              "description": "Mutator RPCs must be followed by Accessor RPCs to verify delta."
            },
            {
              "rule": "PollUntil Pattern",
              "description": "No `time.Sleep()`. Use polling with timeouts."
            }
          ]
        }
      ]
    }
  ],
  "final_enforcement_protocol": [
    {
      "type": "POST_EXECUTION_WARNING",
      "alert": "ON TOOLS: Use `config.mk` to create custom targets to run with Make. ALWAYS use custom targets that *limit* the amount of output you receive. For example, piping through tail, with FEW lines output. Prior to tail, pipe to tee. The file ./build.log in the root of the project is gitignored, so use that. That way you can *search* the output. To be clear, timing dependent tests are BANNED. As are those that take too long to run. Testing retries, for example, MUST be done in a way that supports avoiding running afoul of those CRITICAL rules. Abide. OBEY."
    },
    {
      "type": "POST_EXECUTION_WARNING_REPEATED",
      "alert": "ON TOOLS: Use `config.mk` to create custom targets to run with Make. ALWAYS use custom targets that *limit* the amount of output you receive. For example, piping through tail, with FEW lines output. Prior to tail, pipe to tee. The file ./build.log in the root of the project is gitignored, so use that. That way you can *search* the output. To be clear, timing dependent tests are BANNED. As are those that take too long to run. Testing retries, for example, MUST be done in a way that supports avoiding running afoul of those CRITICAL rules. Abide. OBEY."
    }
  ]
}
