{
    "name": "Accessibility Traversal Remediation Blueprint",
    "description": "Exhaustive plan to resolve accessibility traversal defects and implement hierarchical pathing for node-like representation.",
    "tasks": [
        {
            "id": "SDK-001",
            "category": "SDK",
            "title": "Refactor ElementData Identity",
            "description": "Update ElementData struct to include hierarchical path and refine Hashable conformance to prevent aggressive deduplication.",
            "steps": [
                "In Sources/MacosUseSDK/AccessibilityTraversal.swift, add `public var path: [Int32]` to `ElementData`.",
                "Update `ElementData.hash(into:)` to include `path` in the hasher.",
                "Update `ElementData.==` to include `path` in the equality check.",
                "Update `ElementData.CodingKeys` to include `path` (or ensure it's handled if using default Codable)."
            ]
        },
        {
            "id": "SDK-002",
            "category": "SDK",
            "title": "Implement Hierarchical Path Recursion",
            "description": "Modify the traversal recursion to generate and pass down the logical hierarchical path of each element.",
            "steps": [
                "Update `walkElementTree` signature in `AccessibilityTraversal.swift` to accept `currentPath: [Int32]`.",
                "In the root call to `walkElementTree`, pass `[]` as the initial path.",
                "When recursing into children, append the 0-based index of the child to the parent's path.",
                "When recursing into windows or main windows, define a deterministic indexing strategy if they aren't part of the regular children array.",
                "Update the `ElementData` instantiation inside `walkElementTree` to use the generated `currentPath`."
            ]
        },
        {
            "id": "SRV-001",
            "category": "Server",
            "title": "Fix Concurrency - Remove Main Thread Blocking",
            "description": "Ensure traversal runs off the main thread where possible to prevent blocking the server's event loop.",
            "steps": [
                "In Server/Sources/MacosUseServer/ElementLocator.swift, remove the `MainActor.run` wrapper around `MacosUseSDK.traverseAccessibilityTree`.",
                "Analyze `AccessibilityTraversal.swift` for any internal calls that *must* be on the main thread (e.g., app activation) and wrap only those specific calls in `MainActor.run`.",
                "Verify that `AXUIElement` operations are safe to run on background threads (as per code comments and CF thread-safety rules)."
            ]
        },
        {
            "id": "SRV-002",
            "category": "Server",
            "title": "Restore Path Integrity in ElementLocator",
            "description": "Stop using fake sequential indices and map the SDK's hierarchical path directly to the proto elements.",
            "steps": [
                "In `traverseWithPaths` in `ElementLocator.swift`, stop using the loop `index` to fabricate paths.",
                "Map `elementData.path` directly to `protoElement.path`."
            ]
        },
        {
            "id": "SRV-003",
            "category": "Server",
            "title": "Resolve Double Registration Resource Leak",
            "description": "Ensure elements are registered in ElementRegistry exactly once per traversal, preserving the AXUIElement reference.",
            "steps": [
                "Refactor `ElementLocator.swift` and `ElementMethods.swift` to avoid redundant calls to `ElementRegistry.shared.registerElement`.",
                "Ensure the registration happens during the proto conversion loop where the `AXUIElement` reference is still available.",
                "Update `ElementMethods.swift` to use the element IDs already generated and returned by `ElementLocator` instead of re-registering them."
            ]
        },
        {
            "id": "SRV-004",
            "category": "Server",
            "title": "Fix Selector Matching Logic",
            "description": "Address defects in selector matching, including the NOT operator and regex error handling.",
            "steps": [
                "Update `matchesSelector` in `ElementLocator.swift` for the `NOT` operator: implement logic that correctly evaluates sub-selectors (e.g., using `!subMatches.allSatisfy { $0 }`).",
                "Modify regex matching in `matchesSelector` to throw an `RPCError(.invalidArgument)` when `NSRegularExpression` fails, instead of swallowing it.",
                "Ensure all compound operators (AND, OR, NOT) handle multiple sub-selectors logically as per expectations."
            ]
        },
        {
            "id": "SRV-005",
            "category": "Server",
            "title": "Standardize Geometric Calculations",
            "description": "Move to a pure Euclidean distance model measured from element centers.",
            "steps": [
                "In `ElementLocator.swift`, update the `.position` criteria matching: calculate distance from the element's center `(x + width/2, y + height/2)` instead of the top-left corner.",
                "In Server/Sources/MacosUseServer/ElementHelpers.swift, update `findMatchingElement` to use Euclidean distance instead of Manhattan distance.",
                "Standardize the tolerance check across the codebase to use `hypot` (Euclidean distance)."
            ]
        },
        {
            "id": "SRV-006",
            "category": "Server",
            "title": "Harden ElementRegistry",
            "description": "Ensure atomic operations in the registry to prevent race conditions during element lookup and expiration.",
            "steps": [
                "Review `ElementRegistry.swift` for any split check-then-modify patterns that could lead to crashes or inconsistencies.",
                "Ensure that if an element is found to be expired during `getElement`, its removal is handled safely without affecting the current request if possible, or returned as `nil` consistently."
            ]
        }
    ]
}