import MacosUseProto
@testable import MacosUseServer
import XCTest

/// Tests for the background parameter in OpenApplication
final class BackgroundOpenTests: XCTestCase {
    // MARK: - Proto Request Tests

    /// Verify that OpenApplicationRequest has the background field and defaults to false
    func testOpenApplicationRequestBackgroundFieldDefaultsFalse() {
        let request = Macosusesdk_V1_OpenApplicationRequest()
        XCTAssertFalse(request.background, "background should default to false")
    }

    /// Verify that OpenApplicationRequest.background can be set to true
    func testOpenApplicationRequestBackgroundFieldCanBeSetTrue() {
        var request = Macosusesdk_V1_OpenApplicationRequest()
        request.id = "Calculator"
        request.background = true

        XCTAssertTrue(request.background, "background should be true when set")
        XCTAssertEqual(request.id, "Calculator")
    }

    /// Verify that OpenApplicationRequest.background can be set to false explicitly
    func testOpenApplicationRequestBackgroundFieldCanBeSetFalse() {
        var request = Macosusesdk_V1_OpenApplicationRequest()
        request.id = "Calculator"
        request.background = false

        XCTAssertFalse(request.background, "background should be false when set")
        XCTAssertEqual(request.id, "Calculator")
    }

    /// Verify that OpenApplicationRequest with background=true serializes correctly
    func testOpenApplicationRequestBackgroundSerializesCorrectly() throws {
        var request = Macosusesdk_V1_OpenApplicationRequest()
        request.id = "TestApp"
        request.background = true

        // Serialize and deserialize
        let data = try request.serializedData()
        let decoded = try Macosusesdk_V1_OpenApplicationRequest(serializedBytes: data)

        XCTAssertEqual(decoded.id, "TestApp")
        XCTAssertTrue(decoded.background, "background should survive serialization")
    }

    /// Verify that OpenApplicationRequest with background=false doesn't serialize unnecessary data
    func testOpenApplicationRequestBackgroundFalseSerializesMinimally() throws {
        var request = Macosusesdk_V1_OpenApplicationRequest()
        request.id = "TestApp"
        request.background = false

        // Serialize and deserialize
        let data = try request.serializedData()
        let decoded = try Macosusesdk_V1_OpenApplicationRequest(serializedBytes: data)

        XCTAssertEqual(decoded.id, "TestApp")
        XCTAssertFalse(decoded.background, "background false should survive serialization")
    }

    // MARK: - OpenApplicationRequest Builder Pattern Tests

    func testOpenApplicationRequestWithBuilderBackgroundTrue() {
        let request = Macosusesdk_V1_OpenApplicationRequest.with {
            $0.id = "Calculator"
            $0.background = true
        }

        XCTAssertEqual(request.id, "Calculator")
        XCTAssertTrue(request.background)
    }

    func testOpenApplicationRequestWithBuilderBackgroundFalse() {
        let request = Macosusesdk_V1_OpenApplicationRequest.with {
            $0.id = "Calculator"
            $0.background = false
        }

        XCTAssertEqual(request.id, "Calculator")
        XCTAssertFalse(request.background)
    }

    func testOpenApplicationRequestWithBuilderBackgroundOmitted() {
        let request = Macosusesdk_V1_OpenApplicationRequest.with {
            $0.id = "Calculator"
            // background not set - should default to false
        }

        XCTAssertEqual(request.id, "Calculator")
        XCTAssertFalse(request.background, "background should default to false when omitted")
    }
}
