name: Swift
on:
  workflow_call:
permissions:
  contents: read
jobs:
  test:
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v5
      - name: Build SDK
        run: swift build -c release
      - name: Run SDK tests
        run: swift test
      - name: Build all tools
        run: |-
          set -xe || exit 1
          swift build -c release --product TraversalTool
          swift build -c release --product HighlightTraversalTool
          swift build -c release --product InputControllerTool
          swift build -c release --product VisualInputTool
          swift build -c release --product AppOpenerTool
          swift build -c release --product ActionTool
  # Build and test the gRPC server
  build-server:
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v5
      - name: Check if server exists
        id: check_server
        run: |
          if [ -d "Server" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      - name: Build Server
        if: steps.check_server.outputs.exists == 'true'
        working-directory: Server
        run: swift build -c release
      - name: Test Server
        if: steps.check_server.outputs.exists == 'true'
        working-directory: Server
        run: swift test
