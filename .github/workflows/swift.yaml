name: Swift

on:
  workflow_call:

permissions:
  contents: read

jobs:
  test:
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
      
      - name: Build SDK
        run: swift build -c release
      
      - name: Run SDK tests
        run: swift test
      
      - name: Build all tools
        run: |
          swift build -c release --product TraversalTool
          swift build -c release --product HighlightTraversalTool
          swift build -c release --product InputControllerTool
          swift build -c release --product VisualInputTool
          swift build -c release --product AppOpenerTool
          swift build -c release --product ActionTool

  # This job will build the gRPC server once it's implemented
  build-server:
    runs-on: macos-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Buf
        uses: bufbuild/buf-setup-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Swift Stubs
        run: buf generate
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
      
      - name: Check if server exists
        id: check_server
        run: |
          if [ -d "Server" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Build Server
        if: steps.check_server.outputs.exists == 'true'
        working-directory: Server
        run: swift build -c release
      
      - name: Test Server
        if: steps.check_server.outputs.exists == 'true'
        working-directory: Server
        run: swift test
