# Implementation Plan: MacosUseSDK gRPC Service

**CRITICAL INFORMATION:** This document describes the authoritative implementation plan, which MUST be kept perfectly aligned with `implementation-constraints.md` (the source of truth) and the current state of the repository.

---

## **Objective**

This plan details the construction of a fully-realized, production-grade gRPC server, written in Swift, that exposes the complete functionality of the `MacosUseSDK` via a resource-oriented API.

The implementation adheres strictly to Google's AIPs, centered on a robust, asynchronous control loop (a `@MainActor` global actor) to serially manage all SDK interactions. This architecture guarantees thread safety, supports multi-target automation, and provides a clear, maintainable separation between the API layer and the automation core.

## **Phase 1: API Definition**

This phase defines the API contract in Protobuf, which serves as the single source of truth for the service's interface.

### **1.1 API Structure**

* **Location:** `proto/macosusesdk/v1/`
* **Service:** A single service, `MacosUseService`, is defined in `macos_use.proto` (per AIP-191).
* **Package:** `macosusesdk.v1`

### **1.2 Resources**

The API is resource-oriented, exposing two primary resources:

1.  **Application**
    * **Definition:** `proto/macosusesdk/v1/application.proto`
    * **Name:** `applications/{application}` (where `{application}` is the PID).
    * **Purpose:** Represents a running application instance being tracked by the server.
    * **Methods:**
        * `GetApplication` (AIP-131) - Returns `Application` directly
        * `ListApplications` (AIP-132)
        * `DeleteApplication` (AIP-135) - Returns `google.protobuf.Empty`

2.  **Input**
    * **Definition:** `proto/macosusesdk/v1/input.proto`
    * **Name:** `applications/{application}/inputs/{input}` or `desktopInputs/{input}`.
    * **Purpose:** Represents an input action in a timeline. This forms a circular buffer of completed actions per target, allowing for history and debugging.
    * **Methods:**
        * `CreateInput` (AIP-133) - Returns `Input` directly
        * `GetInput` (AIP-131) - Returns `Input` directly
        * `ListInputs` (AIP-132)

### **1.3 Key Methods**

* **`OpenApplication` (LRO)**
    * **Method:** `rpc OpenApplication(OpenApplicationRequest) returns (google.longrunning.Operation)`
    * **Purpose:** Implements the long-running operation pattern (AIP-151) to asynchronously open or activate an application and begin tracking it as an `Application` resource.

* **Custom Methods (AIP-136)**
    * `TraverseAccessibility`: Retrieves a snapshot of the accessibility tree for a given `Application`.
    * `WatchAccessibility`: A server-streaming RPC that provides real-time diffs of the accessibility tree for a given `Application`.

### **1.4 Common Types**

* **Location:** `proto/macosusesdk/type/`
* **Purpose:** Reusable types (per AIP-213) such as `Element` and `Point` are defined in `element.proto` and `geometry.proto`.

---

## **Phase 2: Core Server Architecture (Swift)**

This phase implements the Swift server executable, state management, and the central control loop. This architecture is defined by the *correct* files in the repository.

* **`AutomationCoordinator.swift` (@MainActor)**
    * **Purpose:** The central control loop (CQRS-style). This `@MainActor` global actor is the **only** entity that can call `MacosUseSDK` functions. It serializes all automation commands on the main thread, satisfying SDK requirements and ensuring thread-safety.

* **`AppStateStore.swift` (actor)**
    * **Purpose:** A thread-safe `actor` that holds the copy-on-write "view" of the server state (e.g., the map of tracked `Application` resources). It provides serial access to shared state and can be safely queried by any gRPC handler.

* **`ServerConfig.swift`**
    * **Purpose:** Loads server configuration (listen address, port, Unix socket path) from environment variables.

---

## **Phase 3: gRPC Service Implementation (Swift)**

This phase implements the gRPC provider class that bridges gRPC requests from clients to the `AutomationCoordinator`.

* **`MacosUseServiceProvider.swift`**
    * **Purpose:** The single gRPC service provider that implements the `Macosusesdk_V1_MacosUseAsyncProvider` protocol (generated by `buf`).
    * **Function:**
        1.  Receives incoming RPCs (e.g., `CreateInput`, `GetApplication`).
        2.  Performs request validation and state lookups via `AppStateStore`.
        3.  Delegates all automation-related work (which requires main-thread access) to the `AutomationCoordinator`.
        4.  Maps results from the SDK and `AppStateStore` back to Protobuf responses.

* **`main.swift`**
    * **Purpose:** The server entry point.
    * **Function:**
        1.  Initializes `NSApplication.shared` (critical for SDK).
        2.  Loads `ServerConfig`.
        3.  Initializes `AppStateStore`.
        4.  Initializes the single `MacosUseServiceProvider`.
        5.  Starts the `grpc-swift` server, binding it to the configured address/socket and registering the `MacosUseServiceProvider`.
        6.  Calls `RunLoop.main.run()` to park the main thread, keeping the app alive and allowing the `@MainActor` (`AutomationCoordinator`) to function.

* **`Package.swift`**
    * **Purpose:** Defines the Swift package.
    * **Function:** Declares the `MacosUseServer` executable, its dependencies (`grpc-swift`, `MacosUseSDK`), and a dedicated target (`MacosUseSDKProtos`) that correctly points to the generated Swift stub code in `gen/swift`.

