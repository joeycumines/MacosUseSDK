# Implementation Plan: MacosUseSDK gRPC Service

**CRITICAL INFORMATION:** This document describes the authoritative implementation plan, which MUST be kept perfectly aligned with `implementation-constraints.md` (the source of truth) and the current state of the repository.

---

## **Objective**

This plan details the construction of a fully-realized, production-grade gRPC server, written in Swift, that exposes the complete functionality of the `MacosUseSDK` via a resource-oriented API.

The implementation adheres strictly to Google's AIPs, centered on a robust, asynchronous control loop (a `@MainActor` global actor) to serially manage all SDK interactions. This architecture guarantees thread safety, supports multi-target automation, and provides a clear, maintainable separation between the API layer and the automation core.

## **Phase 1: API Definition**

This phase defines the API contract in Protobuf, which serves as the single source of truth for the service's interface.

### **1.1 API Structure**

* **Location:** `proto/macosusesdk/v1/`
* **Service:** A single service, `MacosUse`, is defined in `macos_use.proto` (per AIP-191).
* **Package:** `macosusesdk.v1`

### **1.2 Resources**

The API is resource-oriented, exposing two primary resources:

1.  **Application**
    * **Definition:** `proto/macosusesdk/v1/application.proto`
    * **Name:** `applications/{application}` (where `{application}` is the PID).
    * **Purpose:** Represents a running application instance being tracked by the server.
    * **Methods:**
        * `GetApplication` (AIP-131) - Returns `Application` directly
        * `ListApplications` (AIP-132)
        * `DeleteApplication` (AIP-135) - Returns `google.protobuf.Empty`

2.  **Input**
    * **Definition:** `proto/macosusesdk/v1/input.proto`
    * **Name:** `applications/{application}/inputs/{input}` or `desktopInputs/{input}`.
    * **Purpose:** Represents an input action in a timeline. This forms a circular buffer of completed actions per target, allowing for history and debugging.
    * **Methods:**
        * `CreateInput` (AIP-133) - Returns `Input` directly
        * `GetInput` (AIP-131) - Returns `Input` directly
        * `ListInputs` (AIP-132)

### **1.3 Key Methods**

* **`OpenApplication` (LRO)**
    * **Method:** `rpc OpenApplication(OpenApplicationRequest) returns (google.longrunning.Operation)`
    * **Purpose:** Implements the long-running operation pattern (AIP-151) to asynchronously open or activate an application and begin tracking it as an `Application` resource.

* **Custom Methods (AIP-136)**
    * `TraverseAccessibility`: Retrieves a snapshot of the accessibility tree for a given `Application`.
    * `WatchAccessibility`: A server-streaming RPC that provides real-time diffs of the accessibility tree for a given `Application`.

### **1.4 Common Types**

* **Location:** `proto/macosusesdk/type/`
* **Purpose:** Reusable types (per AIP-213) such as `Element` and `Point` are defined in `element.proto` and `geometry.proto`.

---

## **Phase 2: Core Server Architecture (Swift)**

This phase implements the Swift server executable, state management, and the central control loop. This architecture is defined by the *correct* files in the repository.

* **`AutomationCoordinator.swift` (@MainActor)**
    * **Purpose:** The central control loop (CQRS-style). This `@MainActor` global actor is the **only** entity that can call `MacosUseSDK` functions. It serializes all automation commands on the main thread, satisfying SDK requirements and ensuring thread-safety.

* **`AppStateStore.swift` (actor)**
    * **Purpose:** A thread-safe `actor` that holds the copy-on-write "view" of the server state (e.g., the map of tracked `Application` resources). It provides serial access to shared state and can be safely queried by any gRPC handler.

* **`ServerConfig.swift`**
    * **Purpose:** Loads server configuration (listen address, port, Unix socket path) from environment variables.

---

## **Phase 3: gRPC Service Implementation (Swift)**

This phase implements the gRPC provider classes that bridge gRPC requests from clients to the `AutomationCoordinator`.

* **`MacosUseServiceProvider.swift`**
    * **Purpose:** The primary gRPC service provider that implements the `Macosusesdk_V1_MacosUseAsyncProvider` protocol (generated by `buf`).
    * **Function:**
        1.  Receives incoming RPCs (e.g., `CreateInput`, `GetApplication`, `OpenApplication`).
        2.  Performs request validation and state lookups via `AppStateStore`.
        3.  Delegates all automation-related work (which requires main-thread access) to the `AutomationCoordinator`.
        4.  Maps results from the SDK and `AppStateStore` back to Protobuf responses.
        5.  Manages long-running operations via `OperationStore` for `OpenApplication`.

* **`OperationsProvider.swift`**
    * **Purpose:** Implements the `Google_Longrunning_OperationsAsyncProvider` protocol to support AIP-151 long-running operations.
    * **Function:** Proxies LRO management calls (GetOperation, ListOperations, DeleteOperation, CancelOperation, WaitOperation) to `OperationStore`.

* **`OperationStore.swift` (actor)**
    * **Purpose:** Thread-safe in-memory storage for `google.longrunning.Operation` resources.
    * **Function:** Provides create, update, get, list, delete, cancel, and wait operations for LROs. Not persisted - lives for process lifetime.

* **`main.swift`**
    * **Purpose:** The server entry point.
    * **Function:**
        1.  Initializes `NSApplication.shared` (critical for SDK).
        2.  Loads `ServerConfig`.
        3.  Initializes `AppStateStore` and `OperationStore`.
        4.  Initializes `MacosUseServiceProvider` and `OperationsProvider`.
        5.  Starts the `grpc-swift` server with both providers, binding to configured address/socket.
        6.  Awaits indefinitely to keep the server running and `@MainActor` active.

* **`Package.swift`**
    * **Purpose:** Defines the Swift package.
    * **Function:** Declares the `MacosUseServer` executable, its dependencies (`grpc-swift`, `MacosUseSDK`), and a dedicated target (`MacosUseSDKProtos`) that correctly points to the generated Swift stub code in `Server/Sources/MacosUseSDKProtos`.

---

## **Phase 4: Testing and Quality Assurance**

This phase ensures the implementation is correct, maintainable, and follows best practices.

* **Unit Tests**
    * **Location:** `Server/Tests/MacosUseServerTests/`
    * **Coverage:**
        * `AppStateStoreTests.swift`: Tests for state management (add, get, list, remove targets and inputs)
        * `ServerConfigTests.swift`: Tests for configuration loading from environment variables
    * **Status:** Basic tests implemented. Additional coverage needed for service providers and coordinator.

* **CI/CD**
    * **Location:** `.github/workflows/`
    * **Structure:**
        * `ci.yaml`: Main workflow that orchestrates all checks
        * `buf.yaml`: Reusable workflow for buf lint and breaking change detection
        * `api-linter.yaml`: Reusable workflow for Google API linter
        * `swift.yaml`: Reusable workflow for Swift build and test
    * **Features:** Push/PR triggers on main, workflow_dispatch, final summary job

* **Code Generation**
    * **Tools:** `buf` (configured via `buf.yaml` and `buf.gen.yaml`)
    * **Output:**
        * Swift: `Server/Sources/MacosUseSDKProtos/`
        * Go: `gen/go/`
    * **Process:** All generated code is committed to repository

---

## **Current Implementation Status**

### **Completed**

1. ✅ Proto API definition with all resources, methods, and types
2. ✅ Buf configuration for code generation and linting
3. ✅ Google API linter integration with proper script and config
4. ✅ Core server architecture (AutomationCoordinator, AppStateStore, ServerConfig)
5. ✅ gRPC service providers (MacosUseServiceProvider, OperationsProvider)
6. ✅ LRO support via OperationStore
7. ✅ CI/CD workflows (buf, api-linter, swift)
8. ✅ Basic unit tests
9. ✅ Server main entry point with proper initialization
10. ✅ Full build and test suite passing (`make all` runs successfully)

### **Known Issues**

None remaining - all previously identified issues have been resolved.

### **Recent Audit Findings and Fixes (2025-10-29)**

A comprehensive audit of the entire project was conducted to verify alignment with `implementation-constraints.md`. The following issues were identified and corrected:

**Proto API Issues (FIXED):**
- ❌ AttributeChange incorrectly defined as a resource → ✅ Removed resource annotation (it's not independently addressable)
- ❌ Service comment said "MacosUseService" → ✅ Fixed to "MacosUse" (matches actual service name)
- ❌ Input resource missing desktopInputs pattern → ✅ Added second pattern: `desktopInputs/{input}`
- ❌ CreateInput/ListInputsRequest used wrong resource_reference type → ✅ Changed to child_type for multi-pattern resources
- ❌ CreateInput had duplicate HTTP binding → ✅ Fixed to proper additional_bindings for desktop inputs
- ❌ ListInputs had duplicate HTTP binding → ✅ Fixed to proper additional_bindings for desktop inputs
- ❌ GetInput missing additional_bindings → ✅ Added binding for desktopInputs pattern

**Documentation Issues (FIXED):**
- ❌ proto/README.md referenced gen/swift → ✅ Corrected to Server/Sources/MacosUseSDKProtos
- ❌ implementation-plan.md referenced gen/swift → ✅ Corrected path
- ❌ implementation-plan.md said service was MacosUseService → ✅ Fixed to MacosUse
- ❌ implementation-plan.md was incomplete (only 3 phases) → ✅ Added Phase 4 and status sections

**Code Issues (FIXED):**
- ❌ AppStateStoreTests.swift had syntax error (missing test method closing brace) → ✅ Fixed and added testInputManagement

**CI/CD Issues (FIXED):**
- ❌ swift.yaml workflow regenerated proto code during CI → ✅ Removed buf generate step (violates no-auto-commit constraint)

**Configuration Verified (CORRECT):**
- ✅ buf.yaml lint exceptions are all justified per AIPs taking precedence over buf lint
- ✅ buf.gen.yaml correctly outputs Swift to Server/Sources/MacosUseSDKProtos and Go to gen/go
- ✅ buf.lock present and valid with googleapis dependency
- ✅ google-api-linter.yaml correctly ignores only googleapis protos (no other ignores)
- ✅ hack/google-api-linter.sh follows all constraints (no set -e, proper error handling, tempdir cleanup)
- ✅ CI workflows use reusable pattern correctly
- ✅ CI workflows have proper triggers (push/PR to main, workflow_dispatch)
- ✅ CI has summary job with if: always()

**Architecture Verified (CORRECT):**
- ✅ AutomationCoordinator uses @MainActor correctly
- ✅ AppStateStore is an actor with copy-on-write semantics
- ✅ OperationStore is an actor for LRO management
- ✅ MacosUseServiceProvider implements correct protocol
- ✅ OperationsProvider implements LRO operations
- ✅ ServerConfig loads from environment variables
- ✅ main.swift initialization sequence is correct
- ✅ All proto packages correctly structured (macosusesdk.v1, macosusesdk.type)
- ✅ All proto files have mandatory file options (go_package, java_multiple_files, java_outer_classname, java_package)
- ✅ Resource name fields use IDENTIFIER field_behavior
- ✅ Method signatures are correct per AIPs

**Minor Issues (Non-Breaking, Documented):**
- ℹ️ OpenApplicationRequest uses field name `id` instead of `identifier` - acceptable but less descriptive
- ℹ️ No comprehensive integration tests yet (only unit tests)

### **Next Steps**

1. Expand test coverage for service providers and coordinator
2. Add integration tests
3. Document deployment procedures
4. Consider updating grpc-swift to resolve deprecation warnings (non-critical)

